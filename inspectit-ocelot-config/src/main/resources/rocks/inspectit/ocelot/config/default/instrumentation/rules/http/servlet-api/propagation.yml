# ----------------------------------------------------------------------------------
# Defines Rules and Actions enabling down & up propagation on the Servlet API
# ----------------------------------------------------------------------------------

inspectit:
  instrumentation:
    actions:
      'a_servletapi_downPropagation':
        is-void: true
        imports:
          - java.util
          - javax.servlet
          - javax.servlet.http
        input:
          '_arg0': 'ServletRequest'
          '_context': 'InspectitContext'
        value-body: |
          if (_arg0 instanceof HttpServletRequest) {
            HttpServletRequest req = (HttpServletRequest) _arg0;
            Collection headerKeys = _context.getPropagationHeaderNames();
            Map presentHeaders = new HashMap();
            Iterator it = headerKeys.iterator();
            while (it.hasNext()) {
              String name = (String) it.next();
              java.util.Enumeration values = req.getHeaders(name);
              if (values != null && values.hasMoreElements()) {
                presentHeaders.put(name, String.join(",", Collections.list(values)));
              }
            }
            _context.readDownPropagationHeaders(presentHeaders);
          }

      'a_servletapi_upPropagation':
        is-void: true
        imports:
          - java.util
          - javax.servlet
          - javax.servlet.http
        input:
          'response': 'ServletResponse'
          '_context': 'InspectitContext'
        value-body: |
          if (response instanceof HttpServletResponse) {
            HttpServletResponse res = (HttpServletResponse) response;
            if (!res.isCommitted()) {
              Map headers = _context.getUpPropagationHeaders();
              Iterator it = headers.entrySet().iterator();
              while (it.hasNext()) {
                Map$Entry e = (Map$Entry) it.next();
                res.setHeader((String) e.getKey(), (String) e.getValue());
              }
            }
          }

    rules:
      'r_servletapi_downPropagation':
        include:
          'r_servletapi_detect_entry': true
        scopes:
          's_servletapi_servlet_service': true
          's_servletapi_filter_doFilter': true
        pre-entry:
          'do_down_propagation':
            only-if-true: 'http_is_entry'
            action: 'a_servletapi_downPropagation'

      'r_servletapi_servlet_filter_upPropagation':
        scopes:
          's_servletapi_servlet_service': true
          's_servletapi_filter_doFilter': true
        post-exit:
          do_up_propagation:
            action: 'a_servletapi_upPropagation'
            data-input: 
              'response': '_arg1'

      'r_servletapi_servletresponse_upPropagation':
        scopes:
          's_servletapi_servletresponse_getWriter': true
          's_servletapi_servletresponse_getOutputStream': true
        post-entry:
          'do_up_propagation':
            action: 'a_servletapi_upPropagation'
            data-input:
              'response': '_this'
